<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>An Dân Quân</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database-compat.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto bg-white shadow rounded-lg p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-green-600">Xin chào, <span id="userName">Người dùng</span></h2>
      <button onclick="logout()" class="text-sm text-red-600 hover:underline">Đăng xuất</button>
    </div>

    <!-- Buttons -->
    <div class="flex gap-4 mb-6">
      <button onclick="toggleForm('importForm')" class="bg-green-600 text-white px-4 py-2 rounded">+ Nhập kho</button>
      <button onclick="toggleForm('exportForm')" class="bg-yellow-600 text-white px-4 py-2 rounded">+ Xuất kho</button>
      <button onclick="toggleForm('incomeForm')" class="bg-blue-600 text-white px-4 py-2 rounded">+ Thu tiền</button>
      <button onclick="toggleForm('expenseForm')" class="bg-red-600 text-white px-4 py-2 rounded">+ Chi tiền</button>
    </div>

    <!-- Import Form -->
    <div id="importForm" class="hidden border p-4 rounded bg-green-50 mb-6">
      <h3 class="font-semibold mb-2">Form Nhập Kho</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input id="customerName" placeholder="Tên khách hàng" class="border p-2 rounded" />
        <input id="address" placeholder="Địa chỉ" class="border p-2 rounded" />
        <input id="cccd" placeholder="CCCD" class="border p-2 rounded" />
        <input id="phone" placeholder="Số điện thoại" class="border p-2 rounded" />
      </div>
      <div id="importItems" class="space-y-2 mb-2"></div>
      <button onclick="addItem('importItems')" class="bg-blue-500 text-white px-4 py-1 rounded">+ Thêm mặt hàng</button>
      <div class="mt-4 font-bold">Tổng tiền: <span id="importTotal">0</span> đ</div>
      <button onclick="saveImport()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">Lưu</button>
    </div>

    <!-- Export Form -->
    <div id="exportForm" class="hidden border p-4 rounded bg-yellow-50 mb-6">
      <h3 class="font-semibold mb-2">Form Xuất Kho</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input id="receiverName" placeholder="Người nhận hàng" class="border p-2 rounded" />
        <input id="receiverPhone" placeholder="Số điện thoại" class="border p-2 rounded" />
      </div>
      <div id="exportItems" class="space-y-2 mb-2"></div>
      <button onclick="addItem('exportItems')" class="bg-blue-500 text-white px-4 py-1 rounded">+ Thêm mặt hàng</button>
      <div class="mt-4 font-bold">Tổng tiền: <span id="exportTotal">0</span> đ</div>
      <button onclick="saveExport()" class="mt-2 bg-yellow-600 text-white px-4 py-2 rounded">Lưu</button>
    </div>

    <!-- Income Form -->
    <div id="incomeForm" class="hidden mb-6 bg-white shadow rounded p-4">
      <h3 class="text-lg font-semibold mb-2">Thu tiền</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="number" id="incomeAmount" placeholder="Số tiền" class="border p-2 rounded">
        <input type="text" id="incomeSender" placeholder="Người gửi" class="border p-2 rounded">
        <select id="incomeSource" class="border p-2 rounded">
          <option value="TM">TM</option>
          <option value="VCB">VCB</option>
          <option value="CK">CK</option>
        </select>
        <input type="text" id="incomeContent" placeholder="Nội dung" class="border p-2 rounded">
      </div>
      <textarea id="incomeNote" placeholder="Ghi chú" class="border p-2 rounded w-full mt-2"></textarea>
      <button onclick="saveIncome()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Lưu thu tiền</button>
    </div>

    <!-- Expense Form -->
    <div id="expenseForm" class="hidden mb-6 bg-white shadow rounded p-4">
      <h3 class="text-lg font-semibold mb-2">Chi tiền</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="number" id="expenseAmount" placeholder="Số tiền" class="border p-2 rounded">
        <input type="text" id="expenseContent" placeholder="Nội dung" class="border p-2 rounded">
        <select id="expenseSource" class="border p-2 rounded">
          <option value="TM">TM</option>
          <option value="VCB">VCB</option>
          <option value="CK">CK</option>
        </select>
      </div>
      <textarea id="expenseNote" placeholder="Ghi chú" class="border p-2 rounded w-full mt-2"></textarea>
      <button onclick="saveExpense()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded">Lưu chi tiền</button>
    </div>

    <!-- Nhập kho Table -->
    <h3 class="text-lg font-semibold mb-2 mt-6">Danh sách Nhập kho</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-green-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">Ngày</th>
          <th class="border px-2 py-1">Khách hàng</th>
          <th class="border px-2 py-1 text-center">Số mặt hàng</th>
          <th class="border px-2 py-1 text-right">Tổng tiền</th>
        </tr>
      </thead>
      <tbody id="importTable"></tbody>
    </table>

    <!-- Xuất kho Table -->
    <h3 class="text-lg font-semibold mb-2 mt-6">Danh sách Xuất kho</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-yellow-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">Ngày</th>
          <th class="border px-2 py-1">Người nhận</th>
          <th class="border px-2 py-1 text-center">Số mặt hàng</th>
          <th class="border px-2 py-1 text-right">Tổng tiền</th>
        </tr>
      </thead>
      <tbody id="exportTable"></tbody>
    </table>

    <!-- Thu Chi Table -->
    <h3 class="text-lg font-semibold mb-2 mt-6">Danh sách Thu - Chi</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2 py-1">Loại</th>
          <th class="border px-2 py-1">Ngày</th>
          <th class="border px-2 py-1">Số tiền</th>
          <th class="border px-2 py-1">Người/Nội dung</th>
          <th class="border px-2 py-1">Nguồn</th>
          <th class="border px-2 py-1">Ghi chú</th>
        </tr>
      </thead>
      <tbody id="incomeExpenseTable"></tbody>
    </table>

    <!-- Modal -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded shadow-lg max-w-md w-full p-4">
        <h2 id="modalTitle" class="text-lg font-semibold mb-2">Chi tiết</h2>
        <pre id="modalContent" class="text-sm whitespace-pre-wrap"></pre>
        <div class="flex justify-end gap-2 mt-4">
          <button id="modalEditBtn" class="bg-blue-600 text-white px-4 py-2 rounded">Sửa</button>
          <button id="modalDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded">Xoá</button>
          <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded">Đóng</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAXfVdVR6ABdiJ2iyePUv_wR6AYuyFqZjs",
      authDomain: "warehouse689-d212c.firebaseapp.com",
      databaseURL: "https://warehouse689-d212c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "warehouse689-d212c",
      storageBucket: "warehouse689-d212c.appspot.com",
      messagingSenderId: "524439415659",
      appId: "1:524439415659:web:b0904ee6c3b1fdcfd77a2e"
    };
    firebase.initializeApp(firebaseConfig);
    $(document).ready(function() {
      const auth = firebase.auth();
      const db = firebase.database();
      let currentEditId = null;
      let currentEditType = null;
      auth.onAuthStateChanged(user => {
        if (!user) return location.href = "index.html";
        $("#userName").text(user.email);
        loadTable("imports", "importTable");
        loadTable("exports", "exportTable");
        loadCashflow();
      });
      window.logout = function() {
        auth.signOut().then(() => location.href = "index.html");
      };
      window.toggleForm = function(id) {
        $("#importForm, #exportForm, #incomeForm, #expenseForm").addClass("hidden");
        if (id) $("#" + id).removeClass("hidden");
      };
window.addItem = function (containerId) {
  const itemHtml = `
    <div class="grid grid-cols-5 gap-2">
      <input placeholder="Tên hàng" class="border p-1 rounded" />
      <select class="border p-1 rounded">
        <option value="kg">Kg</option>
        <option value="cái">Cái</option>
      </select>
      <input type="number" placeholder="Số lượng" class="border p-1 rounded qty" />
      <input type="number" placeholder="Đơn giá" class="border p-1 rounded price" />
      <input placeholder="Thành tiền" class="border p-1 rounded bg-gray-100" readonly />
    </div>`;
  $("#" + containerId).append(itemHtml);

  // Gắn lại sự kiện cho các input mới
  bindItemEvents(containerId);
};

      function bindItemEvents(containerId) {
  $(`#${containerId} .qty, #${containerId} .price`).off('input').on('input', function () {
    const row = $(this).closest('div');
    const qty = parseFloat(row.find('.qty').val()) || 0;
    const price = parseFloat(row.find('.price').val()) || 0;
    const amount = qty * price;
    row.find('input:eq(4)').val(amount.toLocaleString());

    updateTotal(containerId);
  });
}


function updateTotal(containerId) {
  let total = 0;
  $(`#${containerId} > div`).each(function () {
    const qty = parseFloat($(this).find('.qty').val()) || 0;
    const price = parseFloat($(this).find('.price').val()) || 0;
    total += qty * price;
  });
  const totalId = containerId === 'importItems' ? 'importTotal' : 'exportTotal';
  $(`#${totalId}`).text(total.toLocaleString());
}


      function fillItems(containerId, items) {
        const container = $("#" + containerId);
        container.empty();
        items.forEach(item => {
          const row = `
        <div class="grid grid-cols-5 gap-2">
          <input value="${item.name}" class="border p-1 rounded" />
          <select class="border p-1 rounded">
            <option value="Kg" ${item.unit === 'Kg' ? 'selected' : ''}>Kg</option>
            <option value="Cái" ${item.unit === 'Cái' ? 'selected' : ''}>Cái</option>
          </select>
          <input type="number" value="${item.quantity}" class="border p-1 rounded" />
          <input type="number" value="${item.price}" class="border p-1 rounded" />
          <input value="${(item.quantity * item.price).toLocaleString()}" class="border p-1 rounded bg-gray-100" readonly />
        </div>`;
          container.append(row);
        });
        container.find("input, select").off("input").on("input", () => updateTotal(containerId));
      }

      function getValidItems(containerId) {
        const items = [];
        $(`#${containerId} > div`).each(function() {
          const name = $(this).find("input:eq(0)").val();
          const unit = $(this).find("select").val();
          const quantity = parseFloat($(this).find("input:eq(2)").val()) || 0;
          const price = parseFloat($(this).find("input:eq(3)").val()) || 0;
          if (name && unit && quantity && price) {
            items.push({
              name,
              unit,
              quantity,
              price
            });
          }
        });
        return items;
      }

      function getNextId(type, prefix) {
        return db.ref(type).once("value").then(snap => {
          const count = snap.numChildren() + 1;
          return prefix + String(count).padStart(6, '0');
        });
      }
window.saveImport = async function() {
  const name = $('#customerName').val() || 'Không cung cấp thông tin';
  const address = $('#address').val() || 'Không cung cấp thông tin';
  const cccd = $('#cccd').val() || 'Không cung cấp thông tin';
  const phone = $('#phone').val() || 'Không cung cấp thông tin';
  const date = new Date().toISOString();

  const items = [];

  // Truy xuất từng hàng trong form nhập hàng
  $('#importItems > div').each(function () {
    const name = $(this).find('input:eq(0)').val().trim();
    const unit = $(this).find('select').val();
    const quantity = parseFloat($(this).find('input:eq(2)').val()) || 0;
    const price = parseFloat($(this).find('input:eq(3)').val()) || 0;

    if (name && unit && quantity && price) {
      items.push({
        name,
        unit,
        quantity,
        price
      });
    }
  });

  if (items.length === 0) {
    alert("Vui lòng nhập ít nhất một mặt hàng hợp lệ.");
    return;
  }

  const total = items.reduce((sum, i) => sum + i.quantity * i.price, 0);
  const id = currentEditId || await getNextId('imports', 'PNK');

  const data = {
    id,
    name,
    address,
    cccd,
    phone,
    items,
    total,
    date
  };

  db.ref('imports/' + id).set(data).then(() => {
    alert('Đã lưu nhập kho');
    toggleForm(null);
    currentEditId = null;
    loadTable("imports", "importTable");
  });
};

      window.saveExport = async function() {
        const name = $('#receiverName').val() || 'Không cung cấp thông tin';
        const phone = $('#receiverPhone').val() || 'Không cung cấp thông tin';
        const items = getValidItems('exportItems');
        const total = items.reduce((sum, i) => sum + i.quantity * i.price, 0);
        const date = new Date().toISOString();
        const id = currentEditId || await getNextId('exports', 'PXK');
        const data = {
          id,
          name,
          phone,
          items,
          total,
          date
        };
        db.ref('exports/' + id).set(data).then(() => {
          alert('Đã lưu xuất kho');
          toggleForm(null);
          currentEditId = null;
          loadTable("exports", "exportTable");
        });
      };
      window.saveIncome = async function() {
        const amount = parseFloat($('#incomeAmount').val()) || 0;
        const sender = $('#incomeSender').val() || 'Không rõ';
        const source = $('#incomeSource').val() || '';
        const content = $('#incomeContent').val() || '';
        const note = $('#incomeNote').val() || '';
        const date = new Date().toISOString();
        const id = currentEditId || await getNextId('cashflow', 'PT');
        const data = {
          id,
          type: 'thu',
          amount,
          sender,
          source,
          content,
          note,
          date
        };
        db.ref('cashflow/' + id).set(data).then(() => {
          alert('Đã lưu thu tiền');
          toggleForm(null);
          loadCashflow();
          currentEditId = null;
        });
      };
      window.saveExpense = async function() {
        const amount = parseFloat($('#expenseAmount').val()) || 0;
        const content = $('#expenseContent').val() || 'Không rõ';
        const source = $('#expenseSource').val() || '';
        const note = $('#expenseNote').val() || '';
        const date = new Date().toISOString();
        const id = currentEditId || await getNextId('cashflow', 'PC');
        const data = {
          id,
          type: 'chi',
          amount,
          content,
          source,
          note,
          date
        };
        db.ref('cashflow/' + id).set(data).then(() => {
          alert('Đã lưu chi tiền');
          toggleForm(null);
          loadCashflow();
          currentEditId = null;
        });
      };

      function loadTable(type, tableId) {
        const tbody = $("#" + tableId);
        db.ref(type).on("value", snap => {
          tbody.empty();
          let index = 1;
          snap.forEach(child => {
            const d = child.val();
            const row = `
          <tr class="cursor-pointer hover:bg-gray-100" onclick='showModal(${JSON.stringify(d)}, "${type}")'>
            <td class="border px-2 py-1">${index++}</td>
            <td class="border px-2 py-1">${new Date(d.date).toLocaleDateString()}</td>
            <td class="border px-2 py-1">${d.name}</td>
            <td class="border px-2 py-1 text-center">${d.items?.length || 0}</td>
            <td class="border px-2 py-1 text-right">${Number(d.total || d.amount || 0).toLocaleString()}</td>
          </tr>`;
            tbody.append(row);
          });
        });
      }
      window.showModal = function(data, type) {
        currentEditId = data.id;
        currentEditType = type;
        const lines = [`Mã phiếu: ${data.id || ''}`, `Ngày: ${new Date(data.date).toLocaleDateString()}`, `Người: ${data.name || data.sender || ''}`, `Tổng tiền: ${(data.total || data.amount || 0).toLocaleString()} đ`];
        if (data.items) {
          lines.push("--- Mặt hàng ---");
          data.items.forEach((i, idx) => {
            lines.push(`${idx + 1}. ${i.name} - ${i.quantity} ${i.unit} x ${i.price} = ${(i.quantity * i.price).toLocaleString()} đ`);
          });
        } else {
          if (data.content) lines.push(`Nội dung: ${data.content}`);
          if (data.source) lines.push(`Nguồn: ${data.source}`);
          if (data.note) lines.push(`Ghi chú: ${data.note}`);
        }
        $('#modalTitle').text(`Chi tiết ${data.id || ''}`);
        $('#modalContent').text(lines.join("\n"));
        $('#modalEditBtn').off().on('click', () => editRecord(data, type));
        $('#modalDeleteBtn').off().on('click', () => deleteRecord(data.id, type));
        $('#detailModal').removeClass('hidden');
      };

      function editRecord(data, type) {
        if (type === 'imports') {
          $('#customerName').val(data.name);
          $('#address').val(data.address);
          $('#cccd').val(data.cccd);
          $('#phone').val(data.phone);
          fillItems('importItems', data.items);
          toggleForm('importForm');
        } else if (type === 'exports') {
          $('#receiverName').val(data.name);
          $('#receiverPhone').val(data.phone);
          fillItems('exportItems', data.items);
          toggleForm('exportForm');
        } else if (type === 'cashflow') {
          if (data.type === 'thu') {
            $('#incomeAmount').val(data.amount);
            $('#incomeSender').val(data.sender);
            $('#incomeSource').val(data.source);
            $('#incomeContent').val(data.content);
            $('#incomeNote').val(data.note);
            toggleForm('incomeForm');
          } else {
            $('#expenseAmount').val(data.amount);
            $('#expenseContent').val(data.content);
            $('#expenseSource').val(data.source);
            $('#expenseNote').val(data.note);
            toggleForm('expenseForm');
          }
        }
        closeModal();
      }

      function deleteRecord(id, type) {
        if (!id) return;
        if (confirm("Bạn có chắc muốn xoá phiếu này không?")) {
          db.ref(`${type}/${id}`).remove().then(() => {
            alert("Đã xoá phiếu thành công!");
            closeModal();
          });
        }
      }
      window.closeModal = function() {
        $('#detailModal').addClass('hidden');
      };

      function loadCashflow() {
        const tbody = $('#incomeExpenseTable');
        tbody.empty();
        db.ref('cashflow').orderByChild('date').once('value', snap => {
          snap.forEach(child => {
            const d = child.val();
            const row = `
          <tr class="cursor-pointer hover:bg-gray-100" onclick='showModal(${JSON.stringify(d)}, "cashflow")'>
            <td class="border px-2 py-1 text-center">${d.type === 'thu' ? 'Thu' : 'Chi'}</td>
            <td class="border px-2 py-1 text-center">${new Date(d.date).toLocaleDateString()}</td>
            <td class="border px-2 py-1 text-right">${Number(d.amount).toLocaleString()}</td>
            <td class="border px-2 py-1">${d.sender || d.content}</td>
            <td class="border px-2 py-1 text-center">${d.source || ''}</td>
            <td class="border px-2 py-1">${d.note || ''}</td>
          </tr>`;
            tbody.append(row);
          });
        });
      }
    });
  </script>

</body>

</html>
