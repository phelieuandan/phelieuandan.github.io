<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phế Liệu An Dân - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto bg-white shadow rounded-lg p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-green-600">Xin chào, <span id="userName">Người dùng</span></h2>
      <button onclick="logout()" class="text-sm text-red-600 hover:underline">Đăng xuất</button>
    </div>


    <!-- Buttons Thu/Chi -->
<div class="flex gap-4 mb-6">
  <button onclick="toggleForm('importForm')" class="bg-green-600 text-white px-4 py-2 rounded">+ Nhập kho</button>
  <button onclick="toggleForm('exportForm')" class="bg-yellow-600 text-white px-4 py-2 rounded">+ Xuất kho</button>
  <button onclick="toggleForm('incomeForm')" class="bg-blue-600 text-white px-4 py-2 rounded">+ Thu tiền</button>
  <button onclick="toggleForm('expenseForm')" class="bg-red-600 text-white px-4 py-2 rounded">+ Chi tiền</button>
</div>

    <!-- Form Thu tiền -->
<div id="incomeForm" class="hidden mb-6 bg-white shadow rounded p-4">
  <h3 class="text-lg font-semibold mb-2">Thu tiền</h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <input type="number" id="incomeAmount" placeholder="Số tiền" class="border p-2 rounded">
    <input type="text" id="incomeSender" placeholder="Người gửi" class="border p-2 rounded">
    <select id="incomeSource" class="border p-2 rounded">
      <option value="">Nguồn</option>
      <option value="TM">TM</option>
      <option value="VCB">VCB</option>
      <option value="CK">CK</option>
    </select>
    <input type="text" id="incomeContent" placeholder="Nội dung" class="border p-2 rounded">
  </div>
  <textarea id="incomeNote" placeholder="Ghi chú" class="border p-2 rounded w-full mt-2"></textarea>
  <button onclick="saveIncome()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">Lưu thu tiền</button>
</div>

<!-- Form Chi tiền -->
<div id="expenseForm" class="hidden mb-6 bg-white shadow rounded p-4">
  <h3 class="text-lg font-semibold mb-2">Chi tiền</h3>
  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <input type="number" id="expenseAmount" placeholder="Số tiền" class="border p-2 rounded">
    <input type="text" id="expenseContent" placeholder="Nội dung" class="border p-2 rounded">
    <select id="expenseSource" class="border p-2 rounded">
      <option value="">Nguồn</option>
      <option value="TM">TM</option>
      <option value="VCB">VCB</option>
      <option value="CK">CK</option>
    </select>
  </div>
  <textarea id="expenseNote" placeholder="Ghi chú" class="border p-2 rounded w-full mt-2"></textarea>
  <button onclick="saveExpense()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded">Lưu chi tiền</button>
</div>
    <!-- Form Nhập Kho -->
    <div id="importForm" class="hidden border p-4 rounded bg-green-50 mb-6">
      <h3 class="font-semibold mb-2">Form Nhập Kho</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input id="customerName" placeholder="Tên khách hàng" class="border p-2 rounded" />
        <input id="address" placeholder="Địa chỉ" class="border p-2 rounded" />
        <input id="cccd" placeholder="CCCD" class="border p-2 rounded" />
        <input id="phone" placeholder="Số điện thoại" class="border p-2 rounded" />
      </div>
      <div id="importItems" class="space-y-2 mb-2"></div>
      <button onclick="addItem('importItems')" class="bg-blue-500 text-white px-4 py-1 rounded">+ Thêm mặt hàng</button>
      <div class="mt-4 font-bold">Tổng tiền: <span id="importTotal">0</span> đ</div>
      <button onclick="saveImport()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">Lưu</button>
    </div>

    <!-- Form Xuất Kho -->
    <div id="exportForm" class="hidden border p-4 rounded bg-yellow-50 mb-6">
      <h3 class="font-semibold mb-2">Form Xuất Kho</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input id="receiverName" placeholder="Người nhận hàng" class="border p-2 rounded" />
        <input id="receiverPhone" placeholder="Số điện thoại" class="border p-2 rounded" />
      </div>
      <div id="exportItems" class="space-y-2 mb-2"></div>
      <button onclick="addItem('exportItems')" class="bg-blue-500 text-white px-4 py-1 rounded">+ Thêm mặt hàng</button>
      <div class="mt-4 font-bold">Tổng tiền: <span id="exportTotal">0</span> đ</div>
      <button onclick="saveExport()" class="mt-2 bg-yellow-600 text-white px-4 py-2 rounded">Lưu</button>
    </div>

    <!-- Bảng Nhập kho -->
    <h3 class="text-lg font-semibold mb-2 mt-6">Danh sách Nhập kho</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-green-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">Ngày</th>
          <th class="border px-2 py-1">Khách hàng</th>
          <th class="border px-2 py-1 text-center">Số mặt hàng</th>
          <th class="border px-2 py-1 text-right">Tổng tiền</th>
        </tr>
      </thead>
      <tbody id="importTable"></tbody>
    </table>

    <!-- Bảng Xuất kho -->
    <h3 class="text-lg font-semibold mb-2 mt-6">Danh sách Xuất kho</h3>
    <table class="w-full border text-sm">
      <thead class="bg-yellow-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">Ngày</th>
          <th class="border px-2 py-1">Người nhận</th>
          <th class="border px-2 py-1 text-center">Số mặt hàng</th>
          <th class="border px-2 py-1 text-right">Tổng tiền</th>
        </tr>
      </thead>
      <tbody id="exportTable"></tbody>
    </table>
  <!-- Bảng Thu Chi Tồn -->
  <h3 class="text-lg font-semibold mb-2">Danh sách Thu - Chi</h3>
  <table class="w-full border text-sm">
    <thead class="bg-gray-100">
      <tr>
        <th class="border px-2 py-1">Loại</th>
        <th class="border px-2 py-1">Ngày</th>
        <th class="border px-2 py-1">Số tiền</th>
        <th class="border px-2 py-1">Người/Nội dung</th>
        <th class="border px-2 py-1">Nguồn</th>
        <th class="border px-2 py-1">Ghi chú</th>
      </tr>
    </thead>
    <tbody id="incomeExpenseTable"></tbody>
  </table>

    
  </div>


  <!-- Modal Chi tiết phiếu -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded-lg p-6 max-w-2xl w-full">
        <h2 class="text-lg font-bold mb-2" id="modalTitle"></h2>
        <pre id="modalContent" class="text-sm whitespace-pre-wrap"></pre>
        <div class="flex justify-between mt-4">
          <button id="editBtn" class="px-4 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Sửa</button>
          <button id="deleteBtn" class="px-4 py-1 bg-red-500 text-white rounded hover:bg-red-600">Xoá</button>
          <button onclick="closeModal()" class="px-4 py-1 bg-gray-300 rounded hover:bg-gray-400">Đóng</button>
        </div>
      </div>
    </div>




  
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAXfVdVR6ABdiJ2iyePUv_wR6AYuyFqZjs",
    authDomain: "warehouse689-d212c.firebaseapp.com",
    databaseURL: "https://warehouse689-d212c-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "warehouse689-d212c",
    storageBucket: "warehouse689-d212c.appspot.com",
    messagingSenderId: "524439415659",
    appId: "1:524439415659:web:b0904ee6c3b1fdcfd77a2e"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  let currentModalData = null;
  let currentModalType = null;
  let currentEditId = null;
  let currentEditType = null;

  auth.onAuthStateChanged(user => {
    if (!user) return location.href = "index.html";
    document.getElementById("userName").innerText = user.email;
    loadTable("imports", "importTable");
    loadTable("exports", "exportTable");
  });

  function logout() {
    auth.signOut().then(() => location.href = "index.html");
  }

  function toggleForm(id) {
    document.getElementById("importForm").classList.add("hidden");
    document.getElementById("exportForm").classList.add("hidden");
    document.getElementById(id).classList.remove("hidden");
  }

  function addItem(containerId) {
    const div = document.createElement("div");
    div.className = "grid grid-cols-5 gap-2";
    div.innerHTML = `
      <input placeholder="Tên hàng" class="border p-1 rounded" />
      <select class="border p-1 rounded">
        <option value="kg">kg</option>
        <option value="cái">cái</option>
      </select>
      <input type="number" placeholder="Số lượng" class="border p-1 rounded" />
      <input type="number" placeholder="Đơn giá" class="border p-1 rounded" />
      <input placeholder="Thành tiền" class="border p-1 rounded bg-gray-100" readonly />
    `;
    document.getElementById(containerId).appendChild(div);

    div.querySelectorAll("input, select").forEach(input => {
      input.addEventListener("input", () => updateTotal(containerId));
    });
  }

  function updateTotal(containerId) {
    let total = 0;
    document.querySelectorAll(`#${containerId} > div`).forEach(row => {
      const qty = parseFloat(row.children[2].value) || 0;
      const price = parseFloat(row.children[3].value) || 0;
      const amt = qty * price;
      row.children[4].value = amt.toLocaleString();
      total += amt;
    });
    document.getElementById(containerId === "importItems" ? "importTotal" : "exportTotal").innerText = total.toLocaleString();
  }

  function getValidItems(containerId) {
    const items = [];
    document.querySelectorAll(`#${containerId} > div`).forEach(row => {
      const [name, unit, qty, price] = Array.from(row.children).map(e => e.value);
      if (name && unit && qty && price) {
        items.push({ name, unit, quantity: +qty, price: +price });
      }
    });
    return items;
  }

  function saveImport() {
    const name = document.getElementById("customerName").value || "Không cung cấp";
    const address = document.getElementById("address").value || "Không cung cấp";
    const cccd = document.getElementById("cccd").value || "Không cung cấp";
    const phone = document.getElementById("phone").value || "Không cung cấp";
    const items = getValidItems("importItems");
    if (!items.length) return alert("Chưa có mặt hàng hợp lệ!");
    saveRecord("imports", { name, address, cccd, phone, items });
  }

  function saveExport() {
    const name = document.getElementById("receiverName").value || "Không cung cấp";
    const phone = document.getElementById("receiverPhone").value || "Không cung cấp";
    const items = getValidItems("exportItems");
    if (!items.length) return alert("Chưa có mặt hàng hợp lệ!");
    saveRecord("exports", { name, phone, items });
  }

  function saveRecord(type, data) {
    const total = data.items.reduce((sum, i) => sum + i.quantity * i.price, 0);
    const now = new Date().toISOString();

    if (currentEditId && currentEditType === type) {
      db.ref(`${type}/${currentEditId}`).update({ ...data, total, date: now }).then(() => {
        alert("Đã cập nhật phiếu thành công!");
        currentEditId = null;
        currentEditType = null;
        location.reload();
      });
    } else {
      db.ref(type).once("value").then(snap => {
        const count = snap.numChildren() + 1;
        const id = (type === "imports" ? "PNK" : "PXK") + String(count).padStart(3, "0");
        db.ref(`${type}/${id}`).set({ id, date: now, ...data, total }).then(() => location.reload());
      });
    }
  }

  function loadTable(type, tableId) {
    const tbody = document.getElementById(tableId);
    db.ref(type).on("value", snap => {
      tbody.innerHTML = "";
      let index = 1;
      snap.forEach(child => {
        const d = child.val();
        const tr = document.createElement("tr");
        tr.className = "cursor-pointer hover:bg-gray-100";
        tr.onclick = () => showModal(d, type);
        tr.innerHTML = `
          <td class="border px-2 py-1">${index++}</td>
          <td class="border px-2 py-1">${new Date(d.date).toLocaleDateString()}</td>
          <td class="border px-2 py-1">${d.name}</td>
          <td class="border px-2 py-1 text-center">${d.items.length}</td>
          <td class="border px-2 py-1 text-right">${Number(d.total).toLocaleString()}</td>
        `;
        tbody.appendChild(tr);
      });
    });
  }

  function showModal(data, type) {
    currentModalData = data;
    currentModalType = type;
    const lines = [`Mã phiếu: ${data.id}`, `Ngày: ${new Date(data.date).toLocaleDateString()}`, `Người: ${data.name}`, `Tổng tiền: ${Number(data.total).toLocaleString()} đ`, "--- Mặt hàng ---"];
    data.items.forEach((i, idx) => {
      lines.push(`${idx + 1}. ${i.name} - ${i.quantity} ${i.unit} x ${i.price} = ${(i.quantity * i.price).toLocaleString()} đ`);
    });
    document.getElementById("modalTitle").innerText = `Chi tiết ${data.id}`;
    document.getElementById("modalContent").innerText = lines.join("\n");
    document.getElementById("detailModal").classList.remove("hidden");
  }

  document.getElementById("editBtn").onclick = () => {
    if (!currentModalData || !currentModalType) return;
    const formId = currentModalType === "imports" ? "importForm" : "exportForm";
    toggleForm(formId);
    currentEditId = currentModalData.id;
    currentEditType = currentModalType;

    if (currentModalType === "imports") {
      document.getElementById("customerName").value = currentModalData.name;
      document.getElementById("address").value = currentModalData.address || "";
      document.getElementById("cccd").value = currentModalData.cccd || "";
      document.getElementById("phone").value = currentModalData.phone || "";
      fillItems("importItems", currentModalData.items);
    } else {
      document.getElementById("receiverName").value = currentModalData.name;
      document.getElementById("receiverPhone").value = currentModalData.phone || "";
      fillItems("exportItems", currentModalData.items);
    }

    closeModal();
  };

  document.getElementById("deleteBtn").onclick = () => {
    if (!currentModalData || !currentModalType) return;
    if (confirm("Bạn có chắc chắn muốn xoá phiếu này không?")) {
      db.ref(`${currentModalType}/${currentModalData.id}`).remove().then(() => {
        alert("Đã xoá thành công!");
        closeModal();
      });
    }
  };

  function fillItems(containerId, items) {
    const container = document.getElementById(containerId);
    container.innerHTML = "";
    items.forEach(item => {
      const div = document.createElement("div");
      div.className = "grid grid-cols-5 gap-2";
      div.innerHTML = `
        <input value="${item.name}" class="border p-1 rounded" />
        <select class="border p-1 rounded">
          <option value="kg" ${item.unit === "kg" ? "selected" : ""}>kg</option>
          <option value="cái" ${item.unit === "cái" ? "selected" : ""}>cái</option>
        </select>
        <input type="number" value="${item.quantity}" class="border p-1 rounded" />
        <input type="number" value="${item.price}" class="border p-1 rounded" />
        <input value="${(item.quantity * item.price).toLocaleString()}" class="border p-1 rounded bg-gray-100" readonly />
      `;
      container.appendChild(div);
      div.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", () => updateTotal(containerId));
      });
    });
    updateTotal(containerId);
  }

  function closeModal() {
    currentModalData = null;
    document.getElementById("detailModal").classList.add("hidden");
  }
</script>


  
</body>
</html>
