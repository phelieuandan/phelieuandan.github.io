<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Phế Liệu An Dân - Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database-compat.js"></script>
</head>
<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto bg-white shadow rounded-lg p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-green-600">Xin chào, <span id="userName">Người dùng</span></h2>
      <button onclick="logout()" class="text-sm text-red-600 hover:underline">Đăng xuất</button>
    </div>

    <!-- Buttons -->
    <div class="flex gap-4 mb-6">
      <button onclick="toggleForm('importForm')" class="bg-green-600 text-white px-4 py-2 rounded">+ Nhập kho</button>
      <button onclick="toggleForm('exportForm')" class="bg-yellow-600 text-white px-4 py-2 rounded">+ Xuất kho</button>
    </div>

    <!-- Form Nhập Kho -->
    <div id="importForm" class="hidden border p-4 rounded bg-green-50 mb-6">
      <h3 class="font-semibold mb-2">Form Nhập Kho</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input id="customerName" placeholder="Tên khách hàng" class="border p-2 rounded" />
        <input id="address" placeholder="Địa chỉ" class="border p-2 rounded" />
        <input id="cccd" placeholder="CCCD" class="border p-2 rounded" />
        <input id="phone" placeholder="Số điện thoại" class="border p-2 rounded" />
      </div>
      <div id="importItems" class="space-y-2 mb-2"></div>
      <button onclick="addItem('importItems')" class="bg-blue-500 text-white px-4 py-1 rounded">+ Thêm mặt hàng</button>
      <div class="mt-4 font-bold">Tổng tiền: <span id="importTotal">0</span> đ</div>
      <button onclick="saveImport()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">Lưu</button>
    </div>

    <!-- Form Xuất Kho -->
    <div id="exportForm" class="hidden border p-4 rounded bg-yellow-50 mb-6">
      <h3 class="font-semibold mb-2">Form Xuất Kho</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input id="receiverName" placeholder="Người nhận hàng" class="border p-2 rounded" />
        <input id="receiverPhone" placeholder="Số điện thoại" class="border p-2 rounded" />
      </div>
      <div id="exportItems" class="space-y-2 mb-2"></div>
      <button onclick="addItem('exportItems')" class="bg-blue-500 text-white px-4 py-1 rounded">+ Thêm mặt hàng</button>
      <div class="mt-4 font-bold">Tổng tiền: <span id="exportTotal">0</span> đ</div>
      <button onclick="saveExport()" class="mt-2 bg-yellow-600 text-white px-4 py-2 rounded">Lưu</button>
    </div>

    <!-- Bảng Nhập kho -->
    <h3 class="text-lg font-semibold mb-2 mt-6">Danh sách Nhập kho</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-green-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">Ngày</th>
          <th class="border px-2 py-1">Khách hàng</th>
          <th class="border px-2 py-1 text-center">Số mặt hàng</th>
          <th class="border px-2 py-1 text-right">Tổng tiền</th>
        </tr>
      </thead>
      <tbody id="importTable"></tbody>
    </table>

    <!-- Bảng Xuất kho -->
    <h3 class="text-lg font-semibold mb-2 mt-6">Danh sách Xuất kho</h3>
    <table class="w-full border text-sm">
      <thead class="bg-yellow-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">Ngày</th>
          <th class="border px-2 py-1">Người nhận</th>
          <th class="border px-2 py-1 text-center">Số mặt hàng</th>
          <th class="border px-2 py-1 text-right">Tổng tiền</th>
        </tr>
      </thead>
      <tbody id="exportTable"></tbody>
    </table>
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAXfVdVR6ABdiJ2iyePUv_wR6AYuyFqZjs",
      authDomain: "warehouse689-d212c.firebaseapp.com",
      databaseURL: "https://warehouse689-d212c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "warehouse689-d212c",
      storageBucket: "warehouse689-d212c.appspot.com",
      messagingSenderId: "524439415659",
      appId: "1:524439415659:web:b0904ee6c3b1fdcfd77a2e"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    auth.onAuthStateChanged(user => {
      if (!user) return location.href = "index.html";
      document.getElementById("userName").innerText = user.email;
      loadTable("imports", "importTable");
      loadTable("exports", "exportTable");
    });

    function logout() {
      auth.signOut().then(() => location.href = "index.html");
    }

    function toggleForm(id) {
      document.getElementById("importForm").classList.add("hidden");
      document.getElementById("exportForm").classList.add("hidden");
      document.getElementById(id).classList.remove("hidden");
    }

    function addItem(containerId) {
      const div = document.createElement("div");
      div.className = "grid grid-cols-5 gap-2";
      div.innerHTML = `
        <input placeholder="Tên hàng" class="border p-1 rounded" />
        <select class="border p-1 rounded">
          <option value="">ĐVT</option>
          <option value="kg">kg</option>
          <option value="cái">cái</option>
        </select>
        <input type="number" placeholder="Số lượng" class="border p-1 rounded" />
        <input type="number" placeholder="Đơn giá" class="border p-1 rounded" />
        <input placeholder="Thành tiền" class="border p-1 rounded bg-gray-100" readonly />
      `;
      document.getElementById(containerId).appendChild(div);

      div.querySelectorAll("input, select").forEach(input => {
        input.addEventListener("input", () => updateTotal(containerId));
      });
    }

    function updateTotal(containerId) {
      let total = 0;
      document.querySelectorAll(`#${containerId} > div`).forEach(row => {
        const qty = parseFloat(row.children[2].value) || 0;
        const price = parseFloat(row.children[3].value) || 0;
        const amt = qty * price;
        row.children[4].value = amt.toLocaleString();
        total += amt;
      });
      document.getElementById(containerId === "importItems" ? "importTotal" : "exportTotal").innerText = total.toLocaleString();
    }

    function saveImport() {
      const name = document.getElementById("customerName").value || "Không cung cấp";
      const address = document.getElementById("address").value || "Không cung cấp";
      const cccd = document.getElementById("cccd").value || "Không cung cấp";
      const phone = document.getElementById("phone").value || "Không cung cấp";
      const items = getValidItems("importItems");
      if (items.length === 0) return alert("Chưa có mặt hàng hợp lệ!");

      saveRecord("imports", { name, address, cccd, phone, items });
    }

    function saveExport() {
      const name = document.getElementById("receiverName").value || "Không cung cấp";
      const phone = document.getElementById("receiverPhone").value || "Không cung cấp";
      const items = getValidItems("exportItems");
      if (items.length === 0) return alert("Chưa có mặt hàng hợp lệ!");

      saveRecord("exports", { name, phone, items });
    }

    function getValidItems(containerId) {
      const items = [];
      document.querySelectorAll(`#${containerId} > div`).forEach(row => {
        const [ten, dvt, sl, dg] = Array.from(row.children).map(e => e.value);
        if (ten && dvt && sl && dg) {
          items.push({ name: ten, unit: dvt, quantity: sl, price: dg });
        }
      });
      return items;
    }

    function saveRecord(type, data) {
      db.ref(type).once("value").then(snap => {
        const count = snap.numChildren() + 1;
        const id = (type === "imports" ? "PNK" : "PXK") + String(count).padStart(3, "0");
        const total = data.items.reduce((sum, i) => sum + i.quantity * i.price, 0);
        db.ref(`${type}/${id}`).set({
          id,
          date: new Date().toISOString(),
          ...data,
          total
        }).then(() => {
          alert("Đã lưu thành công!");
          location.reload();
        });
      });
    }

    function loadTable(type, tableId) {
      const tbody = document.getElementById(tableId);
      db.ref(type).on("value", snap => {
        tbody.innerHTML = "";
        let index = 1;
        snap.forEach(child => {
          const d = child.val();
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td class="border px-2 py-1">${index++}</td>
            <td class="border px-2 py-1">${new Date(d.date).toLocaleDateString()}</td>
            <td class="border px-2 py-1">${d.name}</td>
            <td class="border px-2 py-1 text-center">${d.items.length}</td>
            <td class="border px-2 py-1 text-right">${Number(d.total).toLocaleString()}</td>
          `;
          tbody.appendChild(tr);
        });
      });
    }
  </script>
</body>
</html>
