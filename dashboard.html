<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>An D√¢n Qu√¢n</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.3.1/firebase-database-compat.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>

<body class="bg-gray-100 p-6">
  <div class="max-w-6xl mx-auto bg-white shadow rounded-lg p-6">
    <!-- Header -->
    <div class="flex justify-between items-center mb-4">
      <h2 class="text-xl font-bold text-green-600">Hi, <span id="userName">Username</span></h2>
      <button onclick="logout()" class="text-sm font-bold text-red-600 hover:underline">Sign out</button>
    </div>

    <h3 class="text-lg font-bold mt-6 mb-2">L·ª£i nhu·∫≠n</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mt-4 mb-4 text-center">
      <div class="bg-white shadow rounded p-4">
        <p class="text-sm text-gray-500">T·ªïng doanh thu</p>
        <p id="totalRevenue" class="text-xl font-bold text-green-600">0 ƒë</p>
      </div>
      <div class="bg-white shadow rounded p-4">
        <p class="text-sm text-gray-500">T·ªïng gi√° v·ªën</p>
        <p id="totalCost" class="text-xl font-bold text-blue-600">0 ƒë</p>
      </div>
      <div class="bg-white shadow rounded p-4">
        <p class="text-sm text-gray-500">Chi ph√≠ ho·∫°t ƒë·ªông</p>
        <p id="totalExpense" class="text-xl font-bold text-orange-600">0 ƒë</p>
      </div>
      <div class="bg-white shadow rounded p-4">
        <p class="text-sm text-gray-500">L·ª£i nhu·∫≠n</p>
        <p id="profitValue" class="text-xl font-bold text-red-600">0 ƒë</p>
      </div>
    </div>

    <h3 class="text-lg font-bold mb-2 mt-6">T·ªìn kho</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">T√™n h√†ng</th>
          <th class="border px-2 py-1 text-center">S·ªë l∆∞·ª£ng</th>
          <th class="border px-2 py-1 text-center">ƒê∆°n v·ªã</th>
          <th class="border px-2 py-1 text-right">Gi√° tr·ªã t·ªìn</th>
        </tr>
      </thead>
      <tbody id="inventoryTable"></tbody>
    </table>

    <h3 class="text-lg font-bold mt-6 mb-2">Ngu·ªìn ti·ªÅn hi·ªán c√≥</h3>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
      <div class="p-4 border rounded bg-white shadow">
        <div class="text-gray-500">TM</div>
        <div id="cashTM" class="text-xl font-bold text-green-600">0 ƒë</div>
      </div>
      <div class="p-4 border rounded bg-white shadow">
        <div class="text-gray-500">VCB</div>
        <div id="cashVCB" class="text-xl font-bold text-green-600">0 ƒë</div>
      </div>
      <div class="p-4 border rounded bg-white shadow">
        <div class="text-gray-500">CK</div>
        <div id="cashCK" class="text-xl font-bold text-green-600">0 ƒë</div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="flex gap-4 mt-6 mb-6">
      <button onclick="toggleForm('importForm')" class="bg-green-600 text-white px-4 py-2 rounded">+ Nh·∫≠p kho</button>
      <button onclick="toggleForm('exportForm')" class="bg-yellow-600 text-white px-4 py-2 rounded">+ Xu·∫•t kho</button>
      <button onclick="toggleForm('incomeForm')" class="bg-blue-600 text-white px-4 py-2 rounded">+ Thu ti·ªÅn</button>
      <button onclick="toggleForm('expenseForm')" class="bg-red-600 text-white px-4 py-2 rounded">+ Chi ti·ªÅn</button>
    </div>

    <!-- Import Form -->
    <div id="importForm" class="hidden border p-4 rounded bg-green-50 mb-6">
      <h3 class="font-bold mb-2">Form Nh·∫≠p Kho</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input id="customerName" placeholder="T√™n kh√°ch h√†ng" class="border p-2 rounded" />
        <input id="address" placeholder="ƒê·ªãa ch·ªâ" class="border p-2 rounded" />
        <input id="cccd" placeholder="CCCD" class="border p-2 rounded" />
        <input id="phone" placeholder="S·ªë ƒëi·ªán tho·∫°i" class="border p-2 rounded" />
      </div>
      <div id="importItems" class="space-y-2 mb-2"></div>
      <button onclick="addItem('importItems')" class="bg-blue-500 text-white px-4 py-1 rounded">+ Th√™m m·∫∑t h√†ng</button>
      <div class="mt-4 font-bold">T·ªïng ti·ªÅn: <span id="importTotal">0</span> ƒë</div>
      <button onclick="saveImport()" class="mt-2 bg-green-600 text-white px-4 py-2 rounded">L∆∞u</button>
    </div>

    <!-- Export Form -->
    <div id="exportForm" class="hidden border p-4 rounded bg-yellow-50 mb-6">
      <h3 class="font-bold mb-2">Form Xu·∫•t Kho</h3>
      <div class="grid grid-cols-2 gap-4 mb-4">
        <input id="receiverName" placeholder="Ng∆∞·ªùi nh·∫≠n h√†ng" class="border p-2 rounded" />
        <input id="receiverPhone" placeholder="S·ªë ƒëi·ªán tho·∫°i" class="border p-2 rounded" />
      </div>
      <div id="exportItems" class="space-y-2 mb-2"></div>
      <button onclick="addItem('exportItems')" class="bg-blue-500 text-white px-4 py-1 rounded">+ Th√™m m·∫∑t h√†ng</button>
      <div class="mt-4 font-bold">T·ªïng ti·ªÅn: <span id="exportTotal">0</span> ƒë</div>
      <button onclick="saveExport()" class="mt-2 bg-yellow-600 text-white px-4 py-2 rounded">L∆∞u</button>
    </div>

    <!-- Income Form -->
    <div id="incomeForm" class="hidden mb-6 bg-white shadow rounded p-4">
      <h3 class="text-lg font-bold mb-4">Thu ti·ªÅn</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="number" id="incomeAmount" placeholder="S·ªë ti·ªÅn" class="border p-2 rounded">
        <input type="text" id="incomeSender" placeholder="Ng∆∞·ªùi g·ª≠i" class="border p-2 rounded">

        <input type="text" id="incomeContent" placeholder="N·ªôi dung" class="border p-2 rounded">
        <select id="incomeCategory" class="border p-2 rounded">
          <option value="">Ph√¢n lo·∫°i</option>
          <option value="doanh thu">Doanh thu</option>
          <option value="v·ªën ƒë·∫ßu t∆∞">V·ªën ƒë·∫ßu t∆∞</option>
          <option value="kh√°c">Kh√°c</option>
        </select>

        <select id="incomeSource" class="border p-2 rounded">
          <option value="">Ngu·ªìn ti·ªÅn</option>
          <option value="TM">TM</option>
          <option value="VCB">VCB</option>
          <option value="CK">CK</option>
        </select>
      </div>

      <textarea id="incomeNote" placeholder="Ghi ch√∫" class="border p-2 rounded w-full mt-4"></textarea>

      <button onclick="saveIncome()" class="mt-4 bg-blue-600 text-white px-4 py-2 rounded">L∆∞u thu ti·ªÅn</button>
    </div>

    <!-- Expense Form -->
    <div id="expenseForm" class="hidden mb-6 bg-white shadow rounded p-4">
      <h3 class="text-lg font-bold mb-4">Chi ti·ªÅn</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <input type="number" id="expenseAmount" placeholder="S·ªë ti·ªÅn" class="border p-2 rounded">
        <input type="text" id="expenseSender" placeholder="Ng∆∞·ªùi g·ª≠i" class="border p-2 rounded">

        <input type="text" id="expenseContent" placeholder="N·ªôi dung" class="border p-2 rounded">
        <select id="expenseCategory" class="border p-2 rounded">
          <option value="">Ph√¢n lo·∫°i</option>
          <option value="chi ph√≠ ho·∫°t ƒë·ªông">Chi ph√≠ ho·∫°t ƒë·ªông</option>
          <option value="chi ph√≠ mua h√†ng">Chi ph√≠ mua h√†ng</option>
          <option value="kh√°c">Kh√°c</option>
        </select>

        <select id="expenseSource" class="border p-2 rounded">
          <option value="">Ngu·ªìn ti·ªÅn</option>
          <option value="TM">TM</option>
          <option value="VCB">VCB</option>
          <option value="CK">CK</option>
        </select>
      </div>

      <textarea id="expenseNote" placeholder="Ghi ch√∫" class="border p-2 rounded w-full mt-4"></textarea>

      <button onclick="saveExpense()" class="mt-4 bg-red-600 text-white px-4 py-2 rounded">L∆∞u chi ti·ªÅn</button>
    </div>

    <!-- Nh·∫≠p kho Table -->
    <h3 class="text-lg font-bold mb-2 mt-6">Nh·∫≠p kho</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-green-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">Ng√†y</th>
          <th class="border px-2 py-1">Kh√°ch h√†ng</th>
          <th class="border px-2 py-1 text-center">S·ªë m·∫∑t h√†ng</th>
          <th class="border px-2 py-1 text-right">T·ªïng ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="importTable"></tbody>
    </table>

    <!-- Xu·∫•t kho Table -->
    <h3 class="text-lg font-bold mb-2 mt-6">Xu·∫•t kho</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-yellow-100">
        <tr>
          <th class="border px-2 py-1">STT</th>
          <th class="border px-2 py-1">Ng√†y</th>
          <th class="border px-2 py-1">Ng∆∞·ªùi nh·∫≠n</th>
          <th class="border px-2 py-1 text-center">S·ªë m·∫∑t h√†ng</th>
          <th class="border px-2 py-1 text-right">T·ªïng ti·ªÅn</th>
        </tr>
      </thead>
      <tbody id="exportTable"></tbody>
    </table>

    <!-- Thu Chi Table -->
    <h3 class="text-lg font-bold mb-2 mt-6">S·ªï qu·ªπ</h3>
    <table class="w-full border text-sm mb-6">
      <thead class="bg-gray-100">
        <tr>
          <th class="border px-2 py-1">Lo·∫°i</th>
          <th class="border px-2 py-1">Ng√†y</th>
          <th class="border px-2 py-1">S·ªë ti·ªÅn</th>
          <th class="border px-2 py-1">Ng∆∞·ªùi/N·ªôi dung</th>
          <th class="border px-2 py-1">Ngu·ªìn</th>
          <th class="border px-2 py-1">Ghi ch√∫</th>
        </tr>
      </thead>
      <tbody id="incomeExpenseTable"></tbody>
    </table>

    <!-- Modal -->
    <div id="detailModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div class="bg-white rounded shadow-lg max-w-md w-full p-4">
        <h2 id="modalTitle" class="text-lg font-bold mb-2">Chi ti·∫øt</h2>
        <pre id="modalContent" class="text-sm whitespace-pre-wrap"></pre>
        <div class="flex justify-end gap-2 mt-4">
          <button id="modalEditBtn" class="bg-blue-600 text-white px-4 py-2 rounded">S·ª≠a</button>
          <button id="modalDeleteBtn" class="bg-red-600 text-white px-4 py-2 rounded">Xo√°</button>
          <button onclick="closeModal()" class="bg-gray-500 text-white px-4 py-2 rounded">ƒê√≥ng</button>
        </div>
      </div>
    </div>
  </div>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAXfVdVR6ABdiJ2iyePUv_wR6AYuyFqZjs",
      authDomain: "warehouse689-d212c.firebaseapp.com",
      databaseURL: "https://warehouse689-d212c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "warehouse689-d212c",
      storageBucket: "warehouse689-d212c.appspot.com",
      messagingSenderId: "524439415659",
      appId: "1:524439415659:web:b0904ee6c3b1fdcfd77a2e"
    };
    firebase.initializeApp(firebaseConfig);
    $(document).ready(function() {
      const auth = firebase.auth();
      const db = firebase.database();
      let currentEditId = null;
      let currentEditType = null;
      auth.onAuthStateChanged(user => {
        if (!user) return location.href = "index.html";
        $("#userName").text(user.email);
        loadTable("imports", "importTable");
        loadTable("exports", "exportTable");
        loadCashflow();
      });
      window.logout = function() {
        auth.signOut().then(() => location.href = "index.html");
      };
      window.toggleForm = function(id) {
        $("#importForm, #exportForm, #incomeForm, #expenseForm").addClass("hidden");
        if (id) $("#" + id).removeClass("hidden");
      };
      window.addItem = function(containerId) {
        const itemHtml = `
  <div class="grid grid-cols-5 gap-2">
    <input placeholder="T√™n h√†ng" class="border p-1 rounded" />
    <select class="border p-1 rounded">
      <option value="Kg">Kg</option>
      <option value="C√°i">C√°i</option>
    </select>
    <input type="number" placeholder="S·ªë l∆∞·ª£ng" class="border p-1 rounded qty" />
    <input type="number" placeholder="ƒê∆°n gi√°" class="border p-1 rounded price" />
    <input placeholder="Th√†nh ti·ªÅn" class="border p-1 rounded bg-gray-100" readonly />
  </div>`;
        $("#" + containerId).append(itemHtml);
      };

      function updateTotal(containerId) {
        let total = 0;
        $(`#${containerId} > div`).each(function() {
          const qty = parseFloat($(this).find('.qty').val()) || 0;
          const price = parseFloat($(this).find('.price').val()) || 0;
          total += qty * price;
        });
        const totalId = containerId === 'importItems' ? 'importTotal' : 'exportTotal';
        $(`#${totalId}`).text(total.toLocaleString());
      }

      function fillItems(containerId, items) {
        const container = $("#" + containerId);
        container.empty();
        items.forEach(item => {
          const row = `
        <div class="grid grid-cols-5 gap-2">
          <input value="${item.name}" class="border p-1 rounded" />
          <select class="border p-1 rounded">
            <option value="Kg" ${item.unit === 'Kg' ? 'selected' : ''}>Kg</option>
            <option value="C√°i" ${item.unit === 'C√°i' ? 'selected' : ''}>C√°i</option>
          </select>
          <input type="number" placeholder="S·ªë l∆∞·ª£ng" value="${item.quantity}" class="border p-1 rounded qty" />
          <input type="number" placeholder="ƒê∆°n gi√°" value="${item.price}" class="border p-1 rounded price" />
          <input value="${(item.quantity * item.price).toLocaleString()}" placeholder="Th√†nh ti·ªÅn" class="border p-1 rounded bg-gray-100" readonly />
        </div>`;
          container.append(row);
        });
        container.find("input, select").off("input").on("input", () => updateTotal(containerId));
      }

      function getNextId(type, prefix) {
        return db.ref(type).once("value").then(snap => {
          const count = snap.numChildren() + 1;
          return prefix + String(count).padStart(6, '0');
        });
      }
      window.saveImport = async function() {
        const name = $('#customerName').val() || 'Kh√¥ng cung c·∫•p th√¥ng tin';
        const address = $('#address').val() || 'Kh√¥ng cung c·∫•p th√¥ng tin';
        const cccd = $('#cccd').val() || 'Kh√¥ng cung c·∫•p th√¥ng tin';
        const phone = $('#phone').val() || 'Kh√¥ng cung c·∫•p th√¥ng tin';
        const date = new Date().toISOString();
        const items = [];
        $('#importItems > div').each(function() {
          const itemName = $(this).find('input:eq(0)').val().trim();
          const unit = $(this).find('select').val();
          const quantity = parseFloat($(this).find('.qty').val()) || 0;
          const price = parseFloat($(this).find('.price').val()) || 0;
          if (itemName && unit && quantity && price) {
            items.push({
              name: itemName,
              unit: unit,
              quantity: quantity,
              price: price
            });
          }
        });
        if (items.length === 0) {
          alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt m·∫∑t h√†ng h·ª£p l·ªá.");
          return;
        }
        const total = items.reduce((sum, i) => sum + i.quantity * i.price, 0);
        const id = currentEditId || await getNextId('imports', 'PNK');
        const data = {
          id,
          name,
          address,
          cccd,
          phone,
          items,
          total,
          date
        };
        db.ref('imports/' + id).set(data).then(() => {
          alert('ƒê√£ l∆∞u nh·∫≠p kho');
          toggleForm(null);
          currentEditId = null;
          loadTable("imports", "importTable");
        });
      };
      window.saveExport = async function() {
        const name = $('#receiverName').val() || 'Kh√¥ng cung c·∫•p th√¥ng tin';
        const phone = $('#receiverPhone').val() || 'Kh√¥ng cung c·∫•p th√¥ng tin';
        const date = new Date().toISOString();
        const items = [];
        $('#exportItems > div').each(function() {
          const itemName = $(this).find('input:eq(0)').val().trim();
          const unit = $(this).find('select').val();
          const quantity = parseFloat($(this).find('.qty').val()) || 0;
          const price = parseFloat($(this).find('.price').val()) || 0;
          if (itemName && unit && quantity && price) {
            items.push({
              name: itemName,
              unit: unit,
              quantity: quantity,
              price: price
            });
          }
        });
        if (items.length === 0) {
          alert("Vui l√≤ng nh·∫≠p √≠t nh·∫•t m·ªôt m·∫∑t h√†ng h·ª£p l·ªá.");
          return;
        }
        const total = items.reduce((sum, i) => sum + i.quantity * i.price, 0);
        const id = currentEditId || await getNextId('exports', 'PXK');
        const data = {
          id,
          name,
          phone,
          items,
          total,
          date
        };
        db.ref('exports/' + id).set(data).then(() => {
          alert('ƒê√£ l∆∞u xu·∫•t kho');
          toggleForm(null);
          currentEditId = null;
          loadTable("exports", "exportTable");
        });
      };
      window.saveIncome = async function() {
        const amount = parseFloat($('#incomeAmount').val()) || 0;
        const sender = $('#incomeSender').val() || 'Kh√¥ng r√µ';
        const content = $('#incomeContent').val() || '';
        const category = $('#incomeCategory').val() || '';
        const source = $('#incomeSource').val() || '';
        const note = $('#incomeNote').val() || '';
        const date = new Date().toISOString();
        const id = currentEditId || await getNextId('cashflow', 'PT');
        const data = {
          id,
          type: 'thu',
          amount,
          sender,
          content,
          category,
          source,
          note,
          date
        };
        db.ref('cashflow/' + id).set(data).then(() => {
          alert('ƒê√£ l∆∞u thu ti·ªÅn');
          toggleForm(null);
          loadCashflow();
          currentEditId = null;
        });
      };
      window.saveExpense = async function() {
        const amount = parseFloat($('#expenseAmount').val()) || 0;
        const sender = $('#expenseSender').val() || 'Kh√¥ng r√µ';
        const content = $('#expenseContent').val() || '';
        const category = $('#expenseCategory').val() || '';
        const source = $('#expenseSource').val() || '';
        const note = $('#expenseNote').val() || '';
        const date = new Date().toISOString();
        const id = currentEditId || await getNextId('cashflow', 'PC');
        const data = {
          id,
          type: 'chi',
          amount,
          sender,
          content,
          category,
          source,
          note,
          date
        };
        db.ref('cashflow/' + id).set(data).then(() => {
          alert('ƒê√£ l∆∞u chi ti·ªÅn');
          toggleForm(null);
          loadCashflow();
          currentEditId = null;
        });
      };

      function loadTable(type, tableId) {
        const tbody = $("#" + tableId);
        db.ref(type).on("value", snap => {
          tbody.empty();
          let index = 1;
          snap.forEach(child => {
            const d = child.val();
            const row = `
          <tr class="cursor-pointer hover:bg-gray-100" onclick='showModal(${JSON.stringify(d)}, "${type}")'>
            <td class="border px-2 py-1">${index++}</td>
            <td class="border px-2 py-1">${new Date(d.date).toLocaleDateString()}</td>
            <td class="border px-2 py-1">${d.name}</td>
            <td class="border px-2 py-1 text-center">${d.items?.length || 0}</td>
            <td class="border px-2 py-1 text-right">${Number(d.total || d.amount || 0).toLocaleString()}</td>
          </tr>`;
            tbody.append(row);
          });
        });
      }
      window.showModal = function(data, type) {
        currentEditId = data.id;
        currentEditType = type;
        const lines = [`M√£ phi·∫øu: ${data.id || ''}`, `Ng√†y: ${new Date(data.date).toLocaleDateString()}`, `Ng∆∞·ªùi: ${data.name || data.sender || ''}`, `T·ªïng ti·ªÅn: ${(data.total || data.amount || 0).toLocaleString()} ƒë`];
        if (data.items) {
          lines.push("--- M·∫∑t h√†ng ---");
          data.items.forEach((i, idx) => {
            lines.push(`${idx + 1}. ${i.name} - ${i.quantity} ${i.unit} x ${i.price} = ${(i.quantity * i.price).toLocaleString()} ƒë`);
          });
        } else {
          if (data.content) lines.push(`N·ªôi dung: ${data.content}`);
          if (data.source) lines.push(`Ngu·ªìn: ${data.source}`);
          if (data.note) lines.push(`Ghi ch√∫: ${data.note}`);
        }
        $('#modalTitle').text(`Chi ti·∫øt ${data.id || ''}`);
        $('#modalContent').text(lines.join("\n"));
        $('#modalEditBtn').off().on('click', () => editRecord(data, type));
        $('#modalDeleteBtn').off().on('click', () => deleteRecord(data.id, type));
        $('#detailModal').removeClass('hidden');
      };

      function editRecord(data, type) {
        if (type === 'imports') {
          $('#customerName').val(data.name);
          $('#address').val(data.address);
          $('#cccd').val(data.cccd);
          $('#phone').val(data.phone);
          fillItems('importItems', data.items);
          toggleForm('importForm');
        } else if (type === 'exports') {
          $('#receiverName').val(data.name);
          $('#receiverPhone').val(data.phone);
          fillItems('exportItems', data.items);
          toggleForm('exportForm');
        } else if (type === 'cashflow') {
          if (data.type === 'thu') {
            $('#incomeAmount').val(data.amount);
            $('#incomeSender').val(data.sender);
            $('#incomeSource').val(data.source);
            $('#incomeContent').val(data.content);
            $('#incomeNote').val(data.note);
            toggleForm('incomeForm');
          } else {
            $('#expenseAmount').val(data.amount);
            $('#expenseContent').val(data.content);
            $('#expenseSource').val(data.source);
            $('#expenseNote').val(data.note);
            toggleForm('expenseForm');
          }
        }
        closeModal();
      }

      function deleteRecord(id, type) {
        if (!id) return;
        if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° phi·∫øu n√†y kh√¥ng?")) {
          db.ref(`${type}/${id}`).remove().then(() => {
            alert("ƒê√£ xo√° phi·∫øu th√†nh c√¥ng!");
            closeModal();
          });
        }
      }
      window.closeModal = function() {
        $('#detailModal').addClass('hidden');
      };

      function loadCashflow() {
        const tbody = $('#incomeExpenseTable');
        tbody.empty();
        db.ref('cashflow').orderByChild('date').once('value', snap => {
          snap.forEach(child => {
            const d = child.val();
            const row = `
          <tr class="cursor-pointer hover:bg-gray-100" onclick='showModal(${JSON.stringify(d)}, "cashflow")'>
            <td class="border px-2 py-1 text-center">${d.type === 'thu' ? 'Thu' : 'Chi'}</td>
            <td class="border px-2 py-1 text-center">${new Date(d.date).toLocaleDateString()}</td>
            <td class="border px-2 py-1 text-right">${Number(d.amount).toLocaleString()}</td>
            <td class="border px-2 py-1">${d.sender || d.content}</td>
            <td class="border px-2 py-1 text-center">${d.source || ''}</td>
            <td class="border px-2 py-1">${d.note || ''}</td>
          </tr>`;
            tbody.append(row);
          });
        });
      }
      $(document).on('input', '.qty, .price', function() {
        const row = $(this).closest('.grid');
        const qty = parseFloat(row.find('.qty').val()) || 0;
        const price = parseFloat(row.find('.price').val()) || 0;
        const amount = qty * price;
        row.find('input[readonly]').val(amount.toLocaleString());
        // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
        if ($(this).closest('#importItems').length) {
          updateTotal('importItems');
        } else if ($(this).closest('#exportItems').length) {
          updateTotal('exportItems');
        }
      });

function calculateInventory() {
  const importBatches = {}; // L∆∞u c√°c l√¥ h√†ng nh·∫≠p theo FIFO
  const inventory = {}; // K·∫øt qu·∫£ t·ªìn kho cu·ªëi c√πng theo FIFO

  // B∆∞·ªõc 1: L·∫•y to√†n b·ªô nh·∫≠p kho
  db.ref('imports').once('value').then(importSnap => {
    importSnap.forEach(importDoc => {
      const items = importDoc.val().items || [];
      items.forEach(item => {
        const key = item.name + '_' + item.unit;
        if (!importBatches[key]) importBatches[key] = [];
        importBatches[key].push({ quantity: item.quantity, price: item.price });
      });
    });

    // B∆∞·ªõc 2: L·∫•y to√†n b·ªô xu·∫•t kho v√† tr·ª´ d·∫ßn theo FIFO
    db.ref('exports').once('value').then(exportSnap => {
      exportSnap.forEach(exportDoc => {
        const items = exportDoc.val().items || [];
        items.forEach(item => {
          const key = item.name + '_' + item.unit;
          let qtyToDeduct = item.quantity;

          const batches = importBatches[key] || [];
          for (let i = 0; i < batches.length && qtyToDeduct > 0; i++) {
            const batch = batches[i];
            if (batch.quantity <= 0) continue;

            const usedQty = Math.min(batch.quantity, qtyToDeduct);
            batch.quantity -= usedQty;
            qtyToDeduct -= usedQty;
          }
        });
      });

      // B∆∞·ªõc 3: T√≠nh l·∫°i t·ªìn kho t·ª´ c√°c batch c√≤n d∆∞
      for (const key in importBatches) {
        const [name, unit] = key.split('_');
        const batches = importBatches[key];
        const total = batches.reduce((acc, b) => {
          acc.quantity += b.quantity;
          acc.value += b.quantity * b.price;
          return acc;
        }, { quantity: 0, value: 0 });

        if (total.quantity > 0) {
          inventory[key] = { name, unit, ...total };
        }
      }

      // B∆∞·ªõc 4: Hi·ªÉn th·ªã k·∫øt qu·∫£ t·ªìn kho
      const tableBody = $('#inventoryTable');
      tableBody.empty();

      Object.values(inventory).forEach((i, index) => {
        tableBody.append(`
          <tr>
            <td class="border px-2 py-1 text-center">${index + 1}</td>
            <td class="border px-2 py-1">${i.name}</td>
            <td class="border px-2 py-1 text-center">${i.quantity}</td>
            <td class="border px-2 py-1 text-center">${i.unit}</td>
            <td class="border px-2 py-1 text-right">${i.value.toLocaleString()} ƒë</td>
          </tr>
        `);
      });

      console.log("‚úÖ T·ªìn kho t√≠nh theo gi√° v·ªën th·ª±c t·∫ø (FIFO):", inventory);
    });
  });
}


      function calculateCashBySource() {
        const sources = {
          TM: 0,
          VCB: 0,
          CK: 0
        };
        db.ref('cashflow').once('value').then(snap => {
          snap.forEach(child => {
            const d = child.val();
            const amount = parseFloat(d.amount) || 0;
            const source = d.source;
            if (!source || !sources.hasOwnProperty(source)) return;
            if (d.type === 'thu') {
              sources[source] += amount;
            } else if (d.type === 'chi') {
              sources[source] -= amount;
            }
          });
          // ‚úÖ Hi·ªÉn th·ªã l√™n console
          console.log("T·ªïng ti·ªÅn theo ngu·ªìn:");
          Object.keys(sources).forEach(key => {
            console.log(`${key}: ${sources[key].toLocaleString()} ƒë`);
          });
          // ‚úÖ Ho·∫∑c c·∫≠p nh·∫≠t l√™n giao di·ªán
          $('#cashTM').text(sources.TM.toLocaleString() + " ƒë");
          $('#cashVCB').text(sources.VCB.toLocaleString() + " ƒë");
          $('#cashCK').text(sources.CK.toLocaleString() + " ƒë");
        });
      }
      async function calculateProfitLossFIFO() {
        const dbRef = firebase.database().ref();
        const [importsSnap, exportsSnap, cashflowSnap] = await Promise.all([
          dbRef.child('imports').once('value'),
          dbRef.child('exports').once('value'),
          dbRef.child('cashflow').once('value')
        ]);
        const stock = [];
        // Chuy·ªÉn d·ªØ li·ªáu nh·∫≠p kho th√†nh h√†ng t·ªìn theo FIFO
        importsSnap.forEach(child => {
          const data = child.val();
          const date = data.date || '';
          data.items.forEach(item => {
            stock.push({
              name: item.name,
              quantity: item.quantity,
              price: item.price,
              date
            });
          });
        });
        // S·∫Øp x·∫øp theo ng√†y nh·∫≠p (FIFO)
        stock.sort((a, b) => new Date(a.date) - new Date(b.date));
        let totalRevenue = 0;
        let totalCost = 0;
        // X·ª≠ l√Ω xu·∫•t kho: t√≠nh gi√° v·ªën theo FIFO
        exportsSnap.forEach(child => {
          const data = child.val();
          totalRevenue += parseFloat(data.total) || 0;
          data.items.forEach(exportItem => {
            let qtyToProcess = exportItem.quantity;
            for (let i = 0; i < stock.length && qtyToProcess > 0; i++) {
              const lot = stock[i];
              if (lot.name === exportItem.name && lot.quantity > 0) {
                const usedQty = Math.min(qtyToProcess, lot.quantity);
                totalCost += usedQty * lot.price;
                lot.quantity -= usedQty;
                qtyToProcess -= usedQty;
              }
            }
          });
        });
        // T√≠nh t·ªïng chi ph√≠ ho·∫°t ƒë·ªông
        let totalExpense = 0;
        cashflowSnap.forEach(child => {
          const data = child.val();
          if (data.type === 'chi' && data.category === 'chi ph√≠ ho·∫°t ƒë·ªông') {
            totalExpense += parseFloat(data.amount) || 0;
          }
        });
        const profit = totalRevenue - totalCost - totalExpense;
        // Hi·ªÉn th·ªã l√™n UI
        $('#totalRevenue').text(totalRevenue.toLocaleString() + " ƒë");
        $('#totalCost').text(totalCost.toLocaleString() + " ƒë");
        $('#totalExpense').text(totalExpense.toLocaleString() + " ƒë");
        $('#profitValue').text(profit.toLocaleString() + " ƒë");
      }
      auth.onAuthStateChanged(user => {
        if (!user) return location.href = "index.html";
        $("#userName").text(user.email);
        calculateInventory();
        calculateCashBySource();
        calculateProfitLossFIFO(); // üëà g·ªçi t√≠nh l√£i l·ªó
      });
    });
  </script>

</body>

</html>
